package com.dms.dms.service;

import com.dms.dms.dto.FileDTO;
import com.dms.dms.entity.Employee;
import com.dms.dms.entity.FileEntity;
import com.dms.dms.entity.Folder;
import com.dms.dms.repository.EmployeeRepository;
import com.dms.dms.repository.FileRepository;
import com.dms.dms.repository.FolderRepository;
import com.dms.dms.util.FileMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import org.springframework.core.io.Resource;
import org.springframework.core.io.UrlResource;
import java.nio.file.Path;
import java.nio.file.Paths;


import java.io.IOException;
import java.nio.file.*;
import java.time.Instant;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class FileService {

    private final FileRepository fileRepository;
    private final FolderRepository folderRepository;
    private final EmployeeRepository employeeRepository;

    @Value("${file.upload-dir}")
    private String uploadDir;

    // Upload file
    public FileDTO uploadFile(Integer folderId, String uploaderId, String fileCategory, MultipartFile file) throws IOException {
        Folder folder = folderRepository.findById(folderId)
                .orElseThrow(() -> new IllegalArgumentException("Folder not found"));
        Employee uploader = employeeRepository.findByEmployeeId(uploaderId)
                .orElseThrow(() -> new IllegalArgumentException("Uploader not found"));

        String extension = getFileExtension(file.getOriginalFilename());
        String physicalName = uploaderId + "_" + UUID.randomUUID() + (extension.isEmpty() ? "" : "." + extension);

        Path targetPath = Paths.get(uploadDir).resolve(physicalName).normalize();
        Files.createDirectories(targetPath.getParent());
        Files.copy(file.getInputStream(), targetPath, StandardCopyOption.REPLACE_EXISTING);

        FileEntity entity = FileEntity.builder()
                .fileName(file.getOriginalFilename())
                .physicalName(physicalName)
                .fileUrl("/uploads/" + physicalName)
                .fileCategory(fileCategory)
                .folder(folder)
                .uploader(uploader)
                .uploadDate(Instant.now())
                .build();

        return FileMapper.toDTO(fileRepository.save(entity));
    }

    // List files by folder
    public List<FileDTO> getFilesByFolder(Integer folderId) {
        return fileRepository.findAll()
                .stream()
                .filter(f -> f.getFolder() != null && f.getFolder().getId().equals(folderId))
                .map(FileMapper::toDTO)
                .collect(Collectors.toList());
    }

    // Download file
    public Resource downloadFile(String physicalName) {
        Path filePath = Paths.get(uploadDir).resolve(physicalName).normalize();
        if (!Files.exists(filePath)) {
            throw new IllegalArgumentException("File not found: " + physicalName);
        }
        return new FileSystemResource(filePath.toFile());
    }

    public Resource loadFileAsResource(String physicalName) {
    try {
        Path filePath = Paths.get(uploadDir).resolve(physicalName).normalize();
        Resource resource = new UrlResource(filePath.toUri());
        if (resource.exists() && resource.isReadable()) {
            return resource;
        } else {
            throw new IllegalArgumentException("File not found: " + physicalName);
        }
    } catch (Exception e) {
        throw new IllegalArgumentException("Could not read file: " + physicalName, e);
    }
}

    public FileEntity getFileById(Integer fileId) {
        return fileRepository.findById(fileId)
                .orElseThrow(() -> new IllegalArgumentException("File not found with id: " + fileId));
    }

    // Delete file
   public void deleteFile(Integer fileId) throws IOException {
    FileEntity entity = fileRepository.findById(fileId)
            .orElseThrow(() -> new IllegalArgumentException("File not found"));

    Path filePath = Paths.get(uploadDir).resolve(entity.getPhysicalName()).normalize();
    Files.deleteIfExists(filePath);

    fileRepository.delete(entity);
}


    private String getFileExtension(String filename) {
        if (filename == null || !filename.contains(".")) return "";
        return filename.substring(filename.lastIndexOf('.') + 1);
    }
}

